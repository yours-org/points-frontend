import {
	ByteString,
	DefaultProvider,
	MethodCallOptions,
	Sha256,
	SigHash,
	SmartContract,
	TestWallet,
	Utils,
	assert,
	bsv,
	byteString2Int,
	hash256,
	method,
	prop,
	reverseByteString,
	sha256,
	toByteString
} from 'scrypt-ts'


const DIFF = BigInt('0x000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF')
const PRIVATE_KEY = 'cPTgmLcnWAjtk4Y5Z8PjDSzwho4VsQDuzLeTLqcwgtEc8bQQzbMt'
const privateKey = bsv.PrivateKey.fromWIF(PRIVATE_KEY || '')
export const signer = new TestWallet(
	privateKey,
	new DefaultProvider({
		network: bsv.Networks.testnet
	})
)

export const deploy = async () => {
	await HashPoints.loadArtifact(HashPointsArtifact)
	const instance = new HashPoints(DIFF)
	await instance.connect(signer)
	const deployTx = await instance.deploy(1)
	localStorage.setItem('point-contract', deployTx.id)
	console.log(`HashPoints contract deployed: ${deployTx.id}`)
}

export const sync = async () => {
	await HashPoints.loadArtifact(HashPointsArtifact)
	await signer.connect()
	const tx = await signer.connectedProvider.getTransaction(localStorage.getItem('point-contract'))
	const instance = HashPoints.fromTx(tx, 0)
	await instance.connect(signer)
	return instance
}

export const mine = async (instance) => {
	const { mine: miner } = await import('@/lib/pkg')
	const solution = miner(localStorage.getItem('point-contract'), 6n, 10000);
	const res = await instance.methods.claim(toByteString(solution.nonce))
	const tx = (await res).tx
	localStorage.setItem('point-contract', tx.id)
	instance = HashPoints.fromTx(tx, 0)
	await instance.connect(signer)
	return instance
}

export class HashPoints extends SmartContract {
	@prop(true)
	points: bigint

	@prop()
	diff_1_target: bigint

	constructor(diff: bigint) {
		super(...arguments)
		this.points = 0n
		this.diff_1_target = diff
	}

	@method()
	public claim(nonce: ByteString) {
		const hash = hash256(this.ctx.utxo.outpoint.txid + nonce)
		const diff = this.diff_1_target / byteString2Int(reverseByteString(hash, 32n))
		assert(diff > 0n, 'minimum difficulty not met')
		this.points = this.points + diff
		const outputs = this.buildStateOutput(this.ctx.utxo.value) + this.buildChangeOutput()
		assert(this.ctx.hashOutputs == hash256(outputs), 'hashOutputs mismatch')
		console.log(`claim("${nonce}"): ${JSON.stringify({ points: this.points })}`)
	}

	@method()
	public redeem(amount: bigint, message: ByteString) {
		assert(amount > 0n, 'amount negative')
		assert(amount <= this.points, 'insufficient balance')
		this.points = this.points - amount
		assert(this.points > 0n, 'points overflow')
		const outputs = this.buildStateOutput(this.ctx.utxo.value) + this.buildChangeOutput()
		assert(this.ctx.hashOutputs == hash256(outputs), 'hashOutputs mismatch')
		console.log(`redeem(${amount} "${message}") ${JSON.stringify({ points: this.points })}`)
	}

	static async buildTxForClaim(
		current: HashPoints,
		options: MethodCallOptions<HashPoints>,
		nonce: ByteString
	) {
		const tx = new bsv.Transaction().addInput(current.buildContractInput())
		const txid = Buffer.from(current.utxo.txId, 'hex').reverse().toString('hex')
		const hash = hash256(txid + nonce)
		const diff = current.diff_1_target / BigInt(`0x${hash}`)
		const next = current.next()
		next.points = next.points + diff
		const stateOutput = Buffer.from(next.buildStateOutput(1n), 'hex')
		tx.addOutput(
			bsv.Transaction.Output.fromBufferReader(new bsv.encoding.BufferReader(stateOutput))
		)
		const defaultAddress = await current.signer.getDefaultAddress()
		tx.change(options.changeAddress || defaultAddress)

		return { tx, atInputIndex: 0, nexts: [] }
	}

	static async buildTxForRedeem(
		current: HashPoints,
		options: MethodCallOptions<HashPoints>,
		amount: bigint,
		message: ByteString
	) {
		const tx = new bsv.Transaction().addInput(current.buildContractInput())
		const next = current.next()
		next.points = next.points - amount
		const stateOutput = Buffer.from(next.buildStateOutput(1n), 'hex')
		tx.addOutput(
			bsv.Transaction.Output.fromBufferReader(new bsv.encoding.BufferReader(stateOutput))
		)
		const defaultAddress = await current.signer.getDefaultAddress()
		tx.change(options.changeAddress || defaultAddress)

		return { tx, atInputIndex: 0, nexts: [] }
	}
}

export const HashPointsArtifact = {
	version: 9,
	compilerVersion: '1.19.2+commit.c3a20a0',
	contract: 'HashPoints',
	md5: '065f099216f8b72de30d0c11adbd468c',
	structs: [
		{
			name: '__scrypt_ts_Change',
			params: [
				{
					name: 'amount',
					type: 'int'
				},
				{
					name: 'address',
					type: 'Ripemd160'
				}
			],
			genericTypes: []
		}
	],
	library: [],
	alias: [],
	abi: [
		{
			type: 'function',
			name: 'claim',
			index: 0,
			params: [
				{
					name: 'nonce',
					type: 'bytes'
				},
				{
					name: '__scrypt_ts_txPreimage',
					type: 'SigHashPreimage'
				},
				{
					name: '__scrypt_ts_changeAmount',
					type: 'int'
				},
				{
					name: '__scrypt_ts_changeAddress',
					type: 'Ripemd160'
				}
			]
		},
		{
			type: 'function',
			name: 'redeem',
			index: 1,
			params: [
				{
					name: 'amount',
					type: 'int'
				},
				{
					name: 'message',
					type: 'bytes'
				},
				{
					name: '__scrypt_ts_txPreimage',
					type: 'SigHashPreimage'
				},
				{
					name: '__scrypt_ts_changeAmount',
					type: 'int'
				},
				{
					name: '__scrypt_ts_changeAddress',
					type: 'Ripemd160'
				}
			]
		},
		{
			type: 'constructor',
			params: [
				{
					name: 'diff',
					type: 'int'
				}
			]
		}
	],
	stateProps: [
		{
			name: 'points',
			type: 'int'
		}
	],
	buildType: 'debug',
	file: 'file:///Users/brandon/proj/yours/hash-points/artifacts/hashPoints.scrypt',
	hex: '0176018801a901ac2097dfd76851bf465e8f715593b217714858bbe9570ff3bd5e33840a34e20ff0262102ba79df5f8ae7604a9830f03c7933028186aede0675a16f025dc4f8be8eec0382201008ce7480da41702918d1ec8e6849ba32b4d65b1e40dc669c31a1e6306b266c000000000000000000<diff>61005a7a75597a597a597a597a597a597a597a597a597a0079597a75587a587a587a587a587a587a587a587a7561607900876301137961007901687f776100005279517f75007f77007901fd87635379537f75517f7761007901007e81517a7561537a75527a527a5379535479937f75537f77527a75517a67007901fe87635379557f75517f7761007901007e81517a7561537a75527a527a5379555479937f75557f77527a75517a67007901ff87635379597f75517f7761007901007e81517a7561537a75527a527a5379595479937f75597f77527a75517a675379517f75007f7761007901007e81517a7561537a75527a527a5379515479937f75517f77527a75517a6868685179517a75517a75517a75517a7561517a7561007961007982775179517951947f755179549451947f77007981527951799454945194517a75517a75517a75517a7561517951797f75537a75527a527a0000537953797f77610079537a75527a527a00527a75517a7561615179517951937f7551797f775179768b537a75527a527a75010051798791517a7561007991636161005379005179557951937f7555797f77815579768b577a75567a567a567a567a567a567a750079014c9f630079547a75537a537a537a527956795579937f7556797f77527a75517a670079014c9c635279567951937f7556797f7761007901007e81517a7561547a75537a537a537a55795193567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670079014d9c635279567952937f7556797f7761007901007e81517a7561547a75537a537a537a55795293567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670079014e9c635279567954937f7556797f7761007901007e81517a7561547a75537a537a537a55795493567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670069686868685579547993567a75557a557a557a557a557a5579755179517a75517a75517a75517a756181615e7a755d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a680118790141615179011379011379210ac407f0e4bd44bfc207355a778b046225a7068fc59ee7eda43ad905aadbffc800206c266b30e6a1319c66dc401e5bd6b432ba49688eecd118297041da8074ce08100115795679615679aa0079610079517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e81517a75615779567956795679567961537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00517951796151795179970079009f63007952799367007968517a75517a75517a7561527a75517a517951795296a0630079527994527a75517a6853798277527982775379012080517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01205279947f7754537993527993013051797e527e54797e58797e527e53797e52797e57797e0079517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a756100795779ac517a75517a75517a75517a75517a75517a75517a75517a75517a7561517a75517a75616901187961007982775179517958947f7551790128947f77517a75517a75615c7a755b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a01187961007901687f7501447f77517a756101207f77815a7a75597a597a597a597a597a597a597a597a597a01187961007901687f7501447f77517a756101207f75007f775b7a755a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a011879610079610079827751795179012c947f7551790134947f77517a75517a756161007901007e81517a7561517a7561597a75587a587a587a587a587a587a587a587a011779011779597a597a7575577a577a577a577a577a577a5a79011a797eaa5d795179517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e8196007900a0695f79517993607a755f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5f7a5a79616100610079635167010068517a7561011179610079009c630100670079686100798277005179014c9f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a756751790200019f63014c527951615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179030000019f63014d527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f63014e527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7567006968686868007953797e517a75517a75517a7561517a75617e5979517961007982775480517951797e0051807e517a75517a75617e517a7561517961007958805279610079827700517902fd009f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a75675179030000019f6301fd527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f6301fe527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179090000000000000000019f6301ff527958615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7568686868007953797e517a75517a75517a75617e517a75517a7561517a7561615a7900a0635979610118790117797e01147e51797e0118797e0116797e517a75615b7961007958805279610079827700517902fd009f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a75675179030000019f6301fd527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f6301fe527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179090000000000000000019f6301ff527958615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7568686868007953797e517a75517a75517a75617e517a75517a7561670068617e5e795179aa87777777777777777777777777777777777777777777777777777777777767607951876301137961007901687f776100005279517f75007f77007901fd87635379537f75517f7761007901007e81517a7561537a75527a527a5379535479937f75537f77527a75517a67007901fe87635379557f75517f7761007901007e81517a7561537a75527a527a5379555479937f75557f77527a75517a67007901ff87635379597f75517f7761007901007e81517a7561537a75527a527a5379595479937f75597f77527a75517a675379517f75007f7761007901007e81517a7561537a75527a527a5379515479937f75517f77527a75517a6868685179517a75517a75517a75517a7561517a7561007961007982775179517951947f755179549451947f77007981527951799454945194517a75517a75517a75517a7561517951797f75537a75527a527a0000537953797f77610079537a75527a527a00527a75517a7561615179517951937f7551797f775179768b537a75527a527a75010051798791517a7561007991636161005379005179557951937f7555797f77815579768b577a75567a567a567a567a567a567a750079014c9f630079547a75537a537a537a527956795579937f7556797f77527a75517a670079014c9c635279567951937f7556797f7761007901007e81517a7561547a75537a537a537a55795193567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670079014d9c635279567952937f7556797f7761007901007e81517a7561547a75537a537a537a55795293567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670079014e9c635279567954937f7556797f7761007901007e81517a7561547a75537a537a537a55795493567a75557a557a557a557a557a557975527956795579937f7556797f77527a75517a670069686868685579547993567a75557a557a557a557a557a5579755179517a75517a75517a75517a756181615e7a755d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a680118790141615179011379011379210ac407f0e4bd44bfc207355a778b046225a7068fc59ee7eda43ad905aadbffc800206c266b30e6a1319c66dc401e5bd6b432ba49688eecd118297041da8074ce08100115795679615679aa0079610079517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e81517a75615779567956795679567961537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00517951796151795179970079009f63007952799367007968517a75517a75517a7561527a75517a517951795296a0630079527994527a75517a6853798277527982775379012080517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01205279947f7754537993527993013051797e527e54797e58797e527e53797e52797e57797e0079517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a756100795779ac517a75517a75517a75517a75517a75517a75517a75517a75517a7561517a75517a75616901187961007982775179517958947f7551790128947f77517a75517a75615c7a755b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a5b7a01187961007901687f7501447f77517a756101207f77815a7a75597a597a597a597a597a597a597a597a597a01187961007901687f7501447f77517a756101207f75007f775b7a755a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a5a7a011879610079610079827751795179012c947f7551790134947f77517a75517a756161007901007e81517a7561517a7561597a75587a587a587a587a587a587a587a587a011779011779597a597a7575577a577a577a577a577a577a011a7900a069011a795e79a1695d79011b79945e7a755d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7a5d7900a0695879616100610079635167010068517a75615f79610079009c630100670079686100798277005179014c9f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a756751790200019f63014c527951615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179030000019f63014d527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f63014e527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7567006968686868007953797e517a75517a75517a7561517a75617e5779517961007982775480517951797e0051807e517a75517a75617e517a7561517961007958805279610079827700517902fd009f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a75675179030000019f6301fd527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f6301fe527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179090000000000000000019f6301ff527958615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7568686868007953797e517a75517a75517a75617e517a75517a7561517a756161587900a0635779610116790115797e01147e51797e0116797e0114797e517a7561597961007958805279610079827700517902fd009f63517951615179517951938000795179827751947f75007f77517a75517a75517a7561517a75675179030000019f6301fd527952615179517951938000795179827751947f75007f77517a75517a75517a75617e517a756751790500000000019f6301fe527954615179517951938000795179827751947f75007f77517a75517a75517a75617e517a75675179090000000000000000019f6301ff527958615179517951938000795179827751947f75007f77517a75517a75517a75617e517a7568686868007953797e517a75517a75517a75617e517a75517a7561670068617e5c795179aa877777777777777777777777777777777777777777777777777777777767006868',
	sourceMapFile: ''
}
